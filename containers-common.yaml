# Generated from https://git.alpinelinux.org/aports/plain/community/containers-common/APKBUILD
package:
  name: containers-common
  version: 0.57.4
  epoch: 0
  description: Configuration files for container tools
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - build-base
      - busybox
      - git
      - go-md2man

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/containers/common
      tag: v${{package.version}}
      expected-commit: 215e898615b7de5f789be60784b8303f2ab6de3d

  - name: Setup containers-common
    runs: |
      install -d ${{targets.destdir}}/etc/containers/certs.d
      install -d ${{targets.destdir}}/etc/containers/oci/hooks.d
      install -d ${{targets.destdir}}/var/lib/containers/sigstore

      install -Dm644 pkg/config/containers.conf ${{targets.destdir}}/etc/containers/containers.conf
      install -Dm644 pkg/config/containers.conf ${{targets.destdir}}/usr/share/containers/containers.conf
      install -Dm644 pkg/seccomp/seccomp.json ${{targets.destdir}}/etc/containers/seccomp.json
      install -Dm644 pkg/seccomp/seccomp.json ${{targets.destdir}}/usr/share/containers/seccomp.json

      make -C docs
      make -C docs PREFIX=/usr DESTDIR="${{targets.destdir}}" install

  - name: Install configuration for containers-image
    runs: |
      git clone --depth=1 https://github.com/containers/image image
      cd ~/image

      # set unqualified-search-registries
      sed -E 's/# (unqualified-search-registries =).*/\1 ["docker.io"]/' -i ./registries.conf
      install -d ${{targets.destdir}}/etc/containers
      install -Dm644 registries.conf ${{targets.destdir}}/etc/containers/registries.conf

      make docs
      make DESTDIR="${{targets.destdir}}" install

  - name: Install configuration for containers-storage
    runs: |
      git clone --depth=1 https://github.com/containers/storage storage
      cd ~/storage

      # fix go-md2man path in containers-storage
      sed -E 's/(GOMD2MAN =).*/\1 go-md2man/' -i ./docs/Makefile

      # set default storage driver
      sed -E 's/(driver =) ""/\1 "overlay"/' -i ./storage.conf

      install -d ${{targets.destdir}}/etc/containers
      install -d ${{targets.destdir}}/usr/share/containers
      install -Dm644 storage.conf ${{targets.destdir}}/etc/containers/storage.conf
      install -Dm644 storage.conf ${{targets.destdir}}/usr/share/containers/storage.conf

      make -C docs
      make -C docs DESTDIR="${{targets.destdir}}" install

  - name: Install configuration for containers-shortnames
    runs: |
      git clone https://github.com/containers/shortnames
      cd ~/shortnames
      install -Dm644 shortnames.conf ${{targets.destdir}}/etc/containers/registries.conf.d/00-shortnames.conf

  - name: Install configuration for skopeo
    runs: |
      git clone https://github.com/containers/skopeo
      cd ~/skopeo

      install -Dm644 default-policy.json ${{targets.destdir}}/etc/containers/policy.json
      install -Dm644 default.yaml ${{targets.destdir}}/etc/containers/registries.d/default.yaml

  - uses: strip

subpackages:
  - name: containers-common-doc
    pipeline:
      - uses: split/manpages
    description: Man pages for container tools

update:
  enabled: true
  github:
    identifier: containers/common
    use-tag: true
    strip-prefix: v
    tag-filter: "0."
