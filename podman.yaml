# Generated from https://git.alpinelinux.org/aports/plain/community/podman/APKBUILD
package:
  name: podman
  version: 4.9.3
  epoch: 0
  description: Simple management tool for pods, containers and images
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - aardvark-dns
      - bash
      - btrfs-progs-dev
      - build-base
      - busybox
      - catatonit
      - conmon
      - containers-common
      - crun
      - gettext
      - go
      - go-md2man
      - gpgme-dev
      - grep
      - iptables
      - libassuan-dev
      - libgpg-error-dev
      - libseccomp-dev
      - man-db
      - netavark
      - python3
      - shadow-subids
      - slirp4netns
      - sqlite-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/containers/podman
      tag: v${{package.version}}
      expected-commit: 8d2b55ddde1bc81f43d018dfc1ac027c06b26a7f

  - uses: go/bump
    with:
      deps: github.com/containerd/containerd@v1.7.9 github.com/opencontainers/runc@v1.1.12

  - uses: patch
    with:
      patches: no-quadlet.patch

  - runs: |
      # https://github.com/mattn/go-sqlite3/issues/1164
      export CGO_CFLAGS="$CFLAGS -D_LARGEFILE64_SOURCE"

      export BUILDTAGS="exclude_graphdriver_devicemapper seccomp apparmor libsqlite3"

      make -j1 podman podman-remote rootlessport docs \
        PREFIX=/usr \
        GOMD2MAN="$(which go-md2man)"

      make install.bin install.remote install.man install.completions \
        PREFIX=/usr DESTDIR="${{targets.destdir}}"

      install -Dm755 ${{package.name}}.initd ${{targets.destdir}}/etc/init.d/${{package.name}}
      install -Dm644 ${{package.name}}.confd ${{targets.destdir}}/etc/conf.d/${{package.name}}

      # remove systemd files
      rm -r ${{targets.destdir}}/usr/lib/tmpfiles.d

  - uses: strip

subpackages:
  - name: podman-doc
    pipeline:
      - uses: split/manpages
    description: podman manpages

  - name: podman-openrc
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/etc/conf.d
          mkdir -p ${{targets.subpkgdir}}/etc/init.d
          mv ${{targets.destdir}}/etc/conf.d/podman ${{targets.subpkgdir}}/etc/conf.d/
          mv ${{targets.destdir}}/etc/init.d/podman ${{targets.subpkgdir}}/etc/init.d/
    description: OpenRC init files for Podman

  - name: podman-bash-completion
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/share/bash-completion
          mv ${{targets.destdir}}/usr/share/bash-completion ${{targets.subpkgdir}}/usr/share/
    description: bash completion for Podman

  - name: podman-fish-completion
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/share/fish
          mv ${{targets.destdir}}/usr/share/fish ${{targets.subpkgdir}}/usr/share/
    description: fish completion for Podman

  - name: podman-zsh-completion
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/share/zsh
          mv ${{targets.destdir}}/usr/share/zsh ${{targets.subpkgdir}}/usr/share/
    description: Zsh completion for Podman

  - name: podman-remote
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/podman-remote ${{targets.subpkgdir}}/usr/bin/
    description: Remote CLI for Podman

  - name: podman-docker
    pipeline:
      - runs: |
          install -d ${{targets.subpkgdir}}/usr/bin
          make PREFIX=/usr DESTDIR="${{targets.subpkgdir}}" install.docker

          # Move man pages
          rm -rf ${{targets.subpkgdir}}/usr/share

          # Remove systemd files
          rm -rf ${{targets.subpkgdir}}/usr/lib
      - uses: strip
    description: Emulate Docker CLI using Podman

  - name: podman-docker-doc
    pipeline:
      - runs: |
          # make target install.docker nor docker-docs are of any use,
          # so lets create the symlinks manually:
          cd docs/build/man

          mkdir -p ${{targets.subpkgdir}}/usr/share/man/man1
          for i in podman*.1; do
            ln -s $i.gz ${{targets.subpkgdir}}/usr/share/man/man1/${i/podman/docker}.gz
          done
    description: Emulate Docker CLI using Podman (documentation)

update:
  enabled: true
  github:
    identifier: containers/podman
    use-tag: true
    strip-prefix: v
